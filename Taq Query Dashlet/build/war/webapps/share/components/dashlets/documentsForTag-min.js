if(typeof(FME)=="undefined"){FME={};}if(typeof(FME.dashlet)=="undefined"){FME.dashlet={};}(function(){var Dom=YAHOO.util.Dom,Event=YAHOO.util.Event;var $html=Alfresco.util.encodeHTML,$links=Alfresco.util.activateLinks;FME.dashlet.DocumentsForTag=function DocumentsForTag_constructor(htmlId){FME.dashlet.DocumentsForTag.superclass.constructor.call(this,"FME.dashlet.DocumentsForTag",htmlId,["button","container","datasource","datatable","paginator","animation"]);this.previewTooltips=[];this.metadataTooltips=[];this.totalRecords=0;this.initialPage=1;return this;};YAHOO.extend(FME.dashlet.DocumentsForTag,Alfresco.component.Base,{previewTooltips:null,metadataTooltips:null,options:{title:"",tag:"faq",site:"",rowsPerPage:10,alwaysDisplayPaginator:false,componentId:""},onReady:function DocumentsForTag_onReady(){var me=this;this.services.preferences=new Alfresco.service.Preferences();var configLink=Dom.get(this.id+"-config-link");if(configLink){Event.addListener(configLink,"click",this.onConfigDashletClick,this,true);}this.widgets.previewTooltip=new YAHOO.widget.Tooltip(this.id+"-previewTooltip",{width:"108px"});this.widgets.previewTooltip.contextTriggerEvent.subscribe(function(type,args){var context=args[0],record=me.widgets.dataTable.getRecord(context.id),thumbnailUrl=Alfresco.constants.PROXY_URI+"api/node/"+record.getData("nodeRef").replace(":/","")+"/content/thumbnails/doclib?c=queue&ph=true";this.cfg.setProperty("text",'<img src="'+thumbnailUrl+'" />');});this.widgets.metadataTooltip=new YAHOO.widget.Tooltip(this.id+"-metadataTooltip");this.widgets.metadataTooltip.contextTriggerEvent.subscribe(function(type,args){var context=args[0],record=me.widgets.dataTable.getRecord(context.id),locn=record.getData("location");var text="<em>"+me.msg("label.path")+":</em> "+$html(locn.path);this.cfg.setProperty("text",text);});var uriDocList=Alfresco.constants.PROXY_URI+"slingshot/doclib/doclist/documents/site/"+this.options.site+"/documentLibrary?filter=tag";this.widgets.dataSource=new YAHOO.util.DataSource(uriDocList,{responseType:YAHOO.util.DataSource.TYPE_JSON,connXhrMode:"queueRequests",responseSchema:{resultsList:"items",metaFields:{paginationRecordOffset:"startIndex",totalRecords:"totalRecords"}}});var favEventClass=Alfresco.util.generateDomId(null,"fav-doc");var renderCellFavourite=function DocumentsForTag_renderCellFavourite(elCell,oRecord,oColumn,oData){var nodeRef=oRecord.getData("nodeRef"),isFavourite=oRecord.getData("isFavourite");Dom.setStyle(elCell,"width",oColumn.width+"px");Dom.setStyle(elCell.parentNode,"width",oColumn.width+"px");elCell.innerHTML='<a class="favourite-document '+favEventClass+(isFavourite?" enabled":"")+'" title="'+me.msg("tip.favourite-document."+(isFavourite?"remove":"add"))+'">&nbsp;</a>';};var renderCellThumbnail=function DocumentsForTag_renderCellThumbnail(elCell,oRecord,oColumn,oData){var name=oRecord.getData("fileName"),title=oRecord.getData("title"),type=oRecord.getData("type"),locn=oRecord.getData("location"),extn=name.substring(name.lastIndexOf("."));Dom.setStyle(elCell,"width",oColumn.width+"px");Dom.setStyle(elCell.parentNode,"width",oColumn.width+"px");var id=me.id+"-preview-"+oRecord.getId(),docDetailsUrl=Alfresco.constants.URL_PAGECONTEXT+"site/"+locn.site+"/document-details?nodeRef="+oRecord.getData("nodeRef");elCell.innerHTML='<span id="'+id+'" class="icon32"><a href="'+docDetailsUrl+'"><img src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/filetypes/"+Alfresco.util.getFileIcon(name)+'" alt="'+extn+'" title="'+$html(title)+'" /></a></span>';me.previewTooltips.push(id);};var renderCellDescription=function DocumentsForTag_renderCellDescription(elCell,oRecord,oColumn,oData){var type=oRecord.getData("type"),locn=oRecord.getData("location");var id=me.id+"-metadata-"+oRecord.getId(),docDetailsUrl=Alfresco.constants.URL_PAGECONTEXT+"site/"+locn.site+"/document-details?nodeRef="+oRecord.getData("nodeRef");var desc='<span id="'+id+'"><a class="theme-color-1" href="'+docDetailsUrl+'">'+$html(oRecord.getData("displayName"))+"</a></span>";desc+='<div class="detail">'+$links($html(oRecord.getData("description")))+"</div>";elCell.innerHTML=desc;me.metadataTooltips.push(id);};var columnDefinitions=[{key:"favourite",label:"Favourite",sortable:false,formatter:renderCellFavourite,width:16},{key:"thumbnail",label:"Thumbnail",sortable:false,formatter:renderCellThumbnail,width:32},{key:"description",label:"Description",sortable:false,formatter:renderCellDescription}];this.widgets.paginator=new YAHOO.widget.Paginator({rowsPerPage:this.options.rowsPerPage,alwaysVisible:this.options.alwaysDisplayPaginator,initialPage:this.initialPage,template:this.msg("tinyPagination.template"),pageReportTemplate:this.msg("tinyPagination.pageReportTemplate"),previousPageLinkLabel:this.msg("tinyPagination.previousPageLinkLabel"),nextPageLinkLabel:this.msg("tinyPagination.nextPageLinkLabel"),firstPageLinkLabel:this.msg("tinyPagination.firstPageLinkLabel"),lastPageLinkLabel:this.msg("tinyPagination.lastPageLinkLabel")});var generateRequest=function DocumentsForTag_generateRequest(oState,oSelf){var page=oState&&oState.pagination?oState.pagination.page:me.initialPage;return"&filterData="+me.options.tag+"&size="+me.options.rowsPerPage+"&pos="+page;};this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-documents",columnDefinitions,this.widgets.dataSource,{initialLoad:true,generateRequest:generateRequest,initialRequest:generateRequest(),dynamicData:true,paginator:this.widgets.paginator,MSG_EMPTY:this.msg("label.loading")});this.widgets.dataTable.handleDataReturnPayload=function DocumentsForTag_handleDataReturnPayload(oRequest,oResponse,oPayload){me.totalRecords=oResponse.meta.totalRecords;return oPayload;};this.widgets.dataTable.doBeforeLoadData=function DocumentsForTag_doBeforeLoadData(sRequest,oResponse,oPayload){if(oResponse.error){try{var response=YAHOO.lang.JSON.parse(oResponse.responseText);me.widgets.dataTable.set("MSG_ERROR",response.message);}catch(e){me.widgets.dataTable.set("MSG_EMPTY",me.msg("label.empty"));me.widgets.dataTable.set("MSG_ERROR",me.msg("label.error"));}}if(oResponse.results.length===0){this.fireEvent("renderEvent",{type:"renderEvent"});}return true;};this.widgets.dataTable.subscribe("renderEvent",function(){this.widgets.paginator.setState({totalRecords:this.totalRecords});this.widgets.paginator.render();this.widgets.previewTooltip.cfg.setProperty("context",this.previewTooltips);this.widgets.metadataTooltip.cfg.setProperty("context",this.metadataTooltips);this.widgets.dataTable.set("MSG_EMPTY",this.msg("label.empty"));},this,true);var fnFavouriteHandler=function DocumentsForTag_fnFavouriteHandler(layer,args){var owner=YAHOO.Bubbling.getOwnerByTagName(args[1].anchor,"div");if(owner!==null){me.onFavouriteDocument.call(me,args[1].target.offsetParent,owner);}return true;};YAHOO.Bubbling.addDefaultAction(favEventClass,fnFavouriteHandler);},onConfigDashletClick:function DocumentsForTag_onConfigDashletClick(e){Event.stopEvent(e);var actionUrl=Alfresco.constants.URL_SERVICECONTEXT+"modules/dashlet/documentsForTag/config/"+encodeURIComponent(this.options.componentId);if(!this.configDialog){this.configDialog=new Alfresco.module.SimpleDialog(this.id+"-configDialog").setOptions({width:"50em",templateUrl:Alfresco.constants.URL_SERVICECONTEXT+"modules/dashlet/documentsForTag/config?tag="+this.options.tag,onSuccess:{fn:function DocumentsForTag_onConfigDashlet_callback(response){var obj=response.json;this.options.title=obj?obj.title:this.options.title;Dom.get(this.id+"-title").innerHTML=this.options.title;this.options.tag=obj?obj.tag:this.options.tag;this.options.rowsPerPage=obj?obj.rowsPerPage:this.options.rowsPerPage;this.widgets.paginator.setRowsPerPage(this.options.rowsPerPage,true);this.widgets.dataSource.sendRequest("&filterData="+this.options.tag+"&size="+this.options.rowsPerPage+"&pos="+this.initialPage,{success:this.widgets.dataTable.onDataReturnInitializeTable,failure:this.widgets.dataTable.onDataReturnInitializeTable,scope:this.widgets.dataTable});},scope:this},doSetupFormsValidation:{fn:function DocumentsForTag_doSetupForm_callback(form){form.addValidation(this.configDialog.id+"-tagpicker-hidden",Alfresco.forms.validation.mandatory,null,"blur");form.addValidation(this.configDialog.id+"-title",Alfresco.forms.validation.mandatory,null,"keyup");form.addValidation(this.configDialog.id+"-rowsPerPage",Alfresco.forms.validation.mandatory,null,"keyup");form.addValidation(this.configDialog.id+"-rowsPerPage",Alfresco.forms.validation.regexMatch,{pattern:/^\d+$/,match:true},"keyup",this.msg("message.validation.rowsPerPage"));form.setShowSubmitStateDynamically(true,false);Dom.get(this.configDialog.id+"-title").value=this.options.title;Dom.get(this.configDialog.id+"-rowsPerPage").value=this.options.rowsPerPage;},scope:this}});}YAHOO.lang.augmentObject(this.configDialog,{onMandatoryControlValueUpdated:function FormUI_onMandatoryControlValueUpdated(layer,args){this.form.updateSubmitElements();}},true);YAHOO.Bubbling.on("mandatoryControlValueUpdated",this.configDialog.onMandatoryControlValueUpdated,this.configDialog);this.configDialog.setOptions({actionUrl:actionUrl}).show();},onFavouriteDocument:function DocumentsForTag_onFavouriteDocument(row){var record=this.widgets.dataTable.getRecord(row),file=record.getData(),nodeRef=file.nodeRef,undoIndex;file.isFavourite=!file.isFavourite;if(this.currentFilter=="favourites"){undoIndex=record.getData("index");this.widgets.dataTable.deleteRow(record);}else{this.widgets.dataTable.updateRow(record,file);}var responseConfig={failureCallback:{fn:function DocumentsForTag_oFD_failure(event,obj){var record=obj.record,file=record.getData();file.isFavourite=!file.isFavourite;if(this.currentFilter=="favourites"){this.widgets.dataTable.addRow(file,obj.undoIndex);}else{this.widgets.dataTable.updateRow(record,file);}Alfresco.util.PopupManager.displayPrompt({text:this.msg("message.favourite.failure",file.displayName)});},scope:this,obj:{record:record,undoIndex:undoIndex}}};var fnPref=file.isFavourite?"add":"remove";this.services.preferences[fnPref].call(this.services.preferences,Alfresco.service.Preferences.FAVOURITE_DOCUMENTS,nodeRef,responseConfig);}});})();